### Section 3: Virtual Hosts
#
# VirtualHost: If you want to maintain multiple domains/hostnames on your
# machine you can setup VirtualHost containers for them. Most configurations
# use only name-based virtual hosts so the server doesn't need to worry about
# IP addresses. This is indicated by the asterisks in the directives below.
#
# Please see the documentation at 
# <URL:http://httpd.apache.org/docs-2.0/vhosts/>
# for further details before you try to setup virtual hosts.
#
# You may use the command line option '-S' to verify your virtual host
# configuration.

#
# Use name-based virtual hosting.
#
#NameVirtualHost guranga.org:80

#
# VirtualHost example:
# Almost any Apache directive may go into a VirtualHost container.
# The first VirtualHost section is used for requests without a known
# server name.
#
#<VirtualHost *:80>
#    ServerAdmin webmaster@dummy-host.example.com
#    DocumentRoot /www/docs/dummy-host.example.com
#    ServerName dummy-host.example.com
#    ErrorLog @rel_logfiledir@/dummy-host.example.com-error_log
#    CustomLog @rel_logfiledir@/dummy-host.example.com-access_log common
#</VirtualHost>


#
# The First Virtual Host is also your DEFAULT Virtual Host.
# This means any requests that do not match any other vhosts will 
# goto this virtual host.
#

<VirtualHost *:80>
	ServerName nd.ruin.nu
	ServerAlias webbie.ndawn.com

	RewriteEngine On
        RewriteCond %{HTTPS} !=on
	RewriteRule ^/(.*) https://%{SERVER_NAME}%{REQUEST_URI} [R]
</VirtualHost>

<VirtualHost *:443>

	ServerName nd.ruin.nu
	ServerAlias webbie.ndawn.com

	ErrorLog logs/ndawn_error_log
	<IfModule mod_log_config.c>
		#TransferLog logs/ndawn_access_log
		CustomLog logs/ndawn_access_log "%h %l %u [%{%F %H:%M:%S}t] \"%r\" %>s %b %T \"%{Referer}i\" \"%{User-Agent}i\""
	</IfModule>

	<IfModule mod_setenvif.c>
		SetEnvIf User-Agent ".*MSIE.*" nokeepalive ssl-unclean-shutdown \
		downgrade-1.0 force-response-1.0
	</IfModule>
    #
    # DocumentRoot: The directory out of which you will serve your
    # documents. By default, all requests are taken from this directory, but
    # symbolic links and aliases may be used to point to other locations.
    #
    DocumentRoot "/var/www/ndawn/htdocs"

    #
    # This should be changed to whatever you set DocumentRoot to.
    #
    <Directory "/var/www/ndawn/htdocs">

        #
        # Possible values for the Options directive are "None", "All",
        # or any combination of:
        #   Indexes Includes FollowSymLinks SymLinksifOwnerMatch ExecCGI MultiViews
        #
        # Note that "MultiViews" must be named *explicitly* --- "Options All"
        # doesn't give it to you.
        #
        # The Options directive is both complicated and important.  Please see
        # http://httpd.apache.org/docs-2.0/mod/core.html#options
        # for more information.
        #
        Options Indexes FollowSymLinks

        #
        # AllowOverride controls what directives may be placed in .htaccess files.
        # It can be "All", "None", or any combination of the keywords:
        #   Options FileInfo AuthConfig Limit
        #
        AllowOverride None
    </Directory>
	<Location />

	AuthName "NewDawn authentication"
	AuthType basic

	PerlAuthenHandler ND::Web::AuthHandler

	Order Deny,Allow
	Require valid-user

	</Location>


    # Disallow browsing of Subversion working copy administrative dirs.  
    <locationmatch "/.svn/>  
	Order allow,deny  
	Deny from all  
    </locationmatch> 
    <Location .*/\.svn/.*>
	Order allow,deny  
	Deny from all  
    </Location>

	PerlSwitches -T -I/var/www/ndawn/code/
	PerlRequire /var/www/ndawn/code/startup.pl
	<Location ~ "^/[\w\\/]*(.*\.(pl|php|pm))?$">
		SetHandler perl-script
		PerlResponseHandler ND
	</Location>

	<Location /perl-status>
		SetHandler perl-script
		PerlResponseHandler Apache2::Status
		Order deny,allow
        	Deny from all
        	Allow from 127.0.0.1
        	Allow from 193.11.248.227
	</Location>

	
    <IfModule peruser.c>
        # this must match a Processor
        ServerEnvironment apache apache
        
        # these are optional - defaults to the values specified in httpd.conf
        MinSpareProcessors 4
        MaxProcessors 20
    </IfModule>
</VirtualHost>

